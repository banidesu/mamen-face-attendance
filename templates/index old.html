<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>Absensi Asisten Lab - Face Recognition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .container {
            max-width: 1000px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
        }

        select {
            display: block;
            margin: 10px auto 20px;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            width: 100%;
            max-width: 300px;
        }

        .video-wrapper {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        video,
        canvas {
            max-width: 100%;
            width: 480px;
            height: auto;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        #info {
            text-align: center;
            margin-top: 10px;
            color: #555;
            font-size: 15px;
        }

        @media (max-width: 1000px) {
            .video-wrapper {
                flex-direction: column;
                align-items: center;
            }

            video,
            canvas {
                width: 90%;
            }
        }
    </style>
</head>

<body>
    <audio id="bip-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

    <div class="container">
        <h1>Absensi Asisten<br>Laboratorium Manajemen Menengah</h1>

        <select id="cameraSelect"></select>

        <div class="video-wrapper">
            <video id="video" autoplay muted></video>
            <canvas id="canvas"></canvas>
        </div>

        <div id="info">Memuat kamera...</div>

        <div id="feedback" style="
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
      color: white;
      background-color: #28a745; /* hijau sukses */
      padding: 10px;
      display: none;
      width: 50%;
      margin: 20px auto;
      border-radius: 8px;
      transition: all 0.3s ease-in-out;
    "></div>

        <div id="progress-container" style="
      width: 50%;
      margin: 10px auto;
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      display: none;
      overflow: hidden;
    ">
            <div id="progress-bar" style="
        height: 100%;
        width: 0%;
        background-color: #17a2b8;
        transition: width 0.2s linear;
      "></div>
        </div>


    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const info = document.getElementById('info');
        const cameraSelect = document.getElementById('cameraSelect');
        let verifyingName = null;
        let verifyStartTime = null;
        let verificationDuration = 3000; // 3 detik
        let verificationInProgress = false;

        let currentStream = null;

        async function getCameras() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            return devices.filter(device => device.kind === 'videoinput');
        }

        async function setupCamera(deviceId) {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            try {
                const constraints = deviceId ? { video: { deviceId: { exact: deviceId } } } : { video: true };
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                await new Promise(resolve => video.onloadedmetadata = resolve);
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                info.textContent = "Kamera siap. Memulai deteksi...";
                startDetection();
            } catch (err) {
                info.textContent = "Gagal mengakses kamera: " + err.message;
            }
        }

        async function startDetection() {
            async function detectFrame() {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('frame', blob, 'frame.jpg');

                    try {
                        const response = await fetch('/detect', {
                            method: 'POST',
                            body: formData,
                        });

                        const data = await response.json();

                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        ctx.lineWidth = 2;
                        ctx.font = "18px Arial";
                        ctx.textBaseline = "top";

                        if (data.detections && data.detections.length > 0) {
                            const det = data.detections[0];
                            const name = det.class_name;
                            const confidence = det.score;
                            const [x1, y1, x2, y2] = det.bbox;
                            const width = x2 - x1;
                            const height = y2 - y1;

                            ctx.strokeStyle = 'red';
                            ctx.fillStyle = 'red';
                            ctx.beginPath();
                            ctx.rect(x1, y1, width, height);
                            ctx.stroke();
                            ctx.fillText(`${name} (${confidence.toFixed(1)}%)`, x1, y1 - 20);

                            // START VERIFICATION LOGIC
                            if (confidence >= 65) {
                                if (!verificationInProgress || verifyingName !== name) {
                                    verifyingName = name;
                                    verifyStartTime = Date.now();
                                    verificationInProgress = true;
                                    showFeedback(`Verifikasi wajah ${name} dimulai...`, 'info');
                                    startProgressBar(verificationDuration); // progress bar mulai
                                } else {
                                    const elapsed = Date.now() - verifyStartTime;
                                    if (elapsed >= verificationDuration) {
                                        // âœ… VERIFIKASI BERHASIL
                                        verificationInProgress = false;
                                        verifyingName = null;
                                        verifyStartTime = null;
                                        resetProgressBar();
                                        playBeep(); // suara bip

                                        // Lakukan absensi
                                        const response2 = await fetch('/detect', {
                                            method: 'POST',
                                            body: formData
                                        });
                                        const result = await response2.json();

                                        if (result.status && result.message) {
                                            showFeedback(result.message, result.status);
                                        }
                                    }
                                }
                            } else {
                                resetVerification(); // confidence terlalu rendah
                            }
                        } else {
                            resetVerification(); // tidak ada wajah
                        }

                    } catch (error) {
                        console.error('Detection error:', error);
                    }

                    setTimeout(detectFrame, 200); // loop
                }, 'image/jpeg');
            }
            detectFrame();
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;

            if (type === 'success') {
                feedback.style.backgroundColor = '#28a745'; // hijau
            } else if (type === 'info') {
                feedback.style.backgroundColor = '#ffc107'; // kuning
            } else {
                feedback.style.backgroundColor = '#dc3545'; // merah
            }

            feedback.style.display = 'block';

            // Sembunyikan setelah 4 detik
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 4000);
        }

        function resetVerification() {
            if (verificationInProgress) {
                showFeedback("Verifikasi dibatalkan. Pastikan wajah terlihat jelas dan lurus ke depan.", "error");
            }
            verifyingName = null;
            verifyStartTime = null;
            verificationInProgress = false;
            resetProgressBar();
        }

        function startProgressBar(duration) {
            const bar = document.getElementById("progress-bar");
            const container = document.getElementById("progress-container");
            bar.style.width = "0%";
            container.style.display = "block";

            let start = Date.now();
            let interval = setInterval(() => {
                let elapsed = Date.now() - start;
                let percent = Math.min((elapsed / duration) * 100, 100);
                bar.style.width = percent + "%";

                if (percent >= 100) {
                    clearInterval(interval);
                }
            }, 100);
        }

        function resetProgressBar() {
            const bar = document.getElementById("progress-bar");
            const container = document.getElementById("progress-container");
            bar.style.width = "0%";
            container.style.display = "none";
        }

        function playBeep() {
            const beep = document.getElementById("bip-sound");
            beep.play();
        }

        async function init() {
            const cameras = await getCameras();
            if (cameras.length === 0) {
                info.textContent = "Tidak ada perangkat kamera terdeteksi.";
                return;
            }

            cameras.forEach((camera, i) => {
                const option = document.createElement('option');
                option.value = camera.deviceId;
                option.text = camera.label || `Kamera ${i + 1}`;
                cameraSelect.appendChild(option);
            });

            cameraSelect.addEventListener('change', () => {
                setupCamera(cameraSelect.value);
            });

            await setupCamera(cameras[0].deviceId);
        }

        init();
    </script>
</body>

</html>